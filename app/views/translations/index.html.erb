<div class="mx-auto w-full max-w-3xl">

  <!-- Header -->
  <div class="mb-6 sm:mb-8">
    <h1 class="text-xl font-semibold tracking-tight text-slate-900 sm:text-2xl">
      Translate sayings
    </h1>
    <p class="mt-2 text-sm text-slate-600 sm:text-base">
      Choose your languages, type a saying, and see the equivalent saying in your target language.
    </p>
  </div>

  <!-- Search Form -->
  <div class="rounded-2xl border border-slate-200 bg-white/95 p-4 shadow-sm sm:p-6">
    <%= form_with url: translations_path,
                  method: :get,
                  class: "space-y-5" do %>

      <%= render "shared/language_selector",
            source_language: @source_language,
            target_language: @target_language,
            source_field: :source_language,
            target_field: :target_language %>

      <!-- Autocomplete Input -->
      <div class="relative"
           data-controller="autocomplete"
           data-autocomplete-submit-on-select-value="true"
           data-autocomplete-source-language-value="<%= @source_language.code %>"
           data-autocomplete-url-value="<%= autocomplete_sayings_path %>"
           data-autocomplete-language-changed-event-value="ts:source-language-changed">

        <label class="mb-1 block text-xs font-medium uppercase tracking-wide text-slate-700">
          Saying
        </label>

        <input
          type="text"
          id="translation_query"
          name="q"
          value="<%= @query %>"
          autocomplete="off"
          required
          minlength="3"
          maxlength="200"
          placeholder="Type a saying in <%= @source_language.name %>…"
          dir="auto"
          role="combobox"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-controls="translation_suggestions"
          class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-[16px] sm:text-sm text-slate-900 shadow-sm
                 placeholder:text-slate-400 focus:border-sky-500 focus:bg-white focus:outline-none focus:ring-1 focus:ring-sky-500/20"
          data-autocomplete-target="input"
          data-action="input->autocomplete#search keydown->autocomplete#handleKeydown"
        />

        <ul
          id="translation_suggestions"
          class="absolute z-30 mt-1 w-full rounded-xl border border-slate-200 bg-white shadow-lg ring-1 ring-black/5 text-sm
                 max-h-64 overflow-y-auto dark:bg-slate-800 dark:border-slate-700 dark:text-slate-100"
          data-autocomplete-target="list"
          role="listbox"
          hidden
        ></ul>
      </div>

      <div class="flex w-full items-center justify-end gap-3 pt-1">
        <button
          type="submit"
          data-turbo-submits-with="Translate"
          class="inline-flex items-center gap-1.5 rounded-full bg-[rgb(26,115,232)] px-4 py-2 text-sm font-medium text-white shadow-sm
                 hover:brightness-90 hover:shadow-md focus-visible:ring-2 focus-visible:ring-slate-900/20
                 focus-visible:ring-offset-2 focus-visible:ring-offset-white disabled:bg-slate-400 disabled:text-white"
        >
          Translate
        </button>
      </div>

    <% end %>
  </div>

  <!-- Results -->
  <% if @source_saying.present? %>
    <section data-test="results" class="mt-8 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm sm:p-5" aria-live="polite">

      <div class="flex flex-wrap items-baseline justify-between gap-x-3 gap-y-1">
        <h2 class="text-sm font-semibold text-slate-800">
          Equivalent sayings in <%= @target_language.name %>
        </h2>
        <p class="text-[11px] text-slate-500">
          <%= @source_language.name %> → <%= @target_language.name %>
        </p>
      </div>

      <% if @translations.any? %>
        <div class="mt-4 space-y-6">

          <% @translations.each do |translation| %>
            <% target_saying =
                 (translation.saying_a_id == @source_saying.id) ?
                   translation.saying_b :
                   translation.saying_a %>

            <div
              class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm space-y-5"
              data-controller="vote"
              data-vote-id-value="<%= translation.id %>"
            >

              <!-- Source Saying -->
              <div class="text-base font-medium text-slate-900 bg-slate-50 rounded-xl p-4 leading-relaxed" dir="auto">
                <%= @source_saying.text %>
              </div>

              <!-- Target Saying -->
              <div class="text-base font-medium text-slate-900 bg-slate-50 rounded-xl p-4 leading-relaxed" dir="auto">
                <%= target_saying.text %>
              </div>

              <div class="h-px bg-slate-200"></div>

              <p class="text-xs text-slate-500 text-center mb-3">Are these sayings equivalent?</p>

              <!-- Voting row -->
              <div class="flex items-center justify-center gap-14 pt-2">

                <!-- Downvote -->
                <button
                  data-action="vote#downvote"
                  class="vote-btn-down flex flex-col items-center gap-2"
                >
                  <div class="vote-circle vote-circle-sm <%= 'vote-active-down' if translation.user_vote_value(current_user) == -1 %>">
                    <svg viewBox="0 0 24 24" fill="none">
                      <path
                        d="M6 6l12 12M18 6l-12 12"
                        stroke="currentColor" stroke-width="2.3" stroke-linecap="round"
                      />
                    </svg>
                  </div>

                  <span data-vote-target="down" class="text-xs text-slate-700">
                    <%= translation.downvotes_count %>
                  </span>
                </button>

                <!-- Upvote -->
                <button
                  data-action="vote#upvote"
                  class="vote-btn-up flex flex-col items-center gap-2"
                >
                  <div class="vote-circle vote-circle-sm <%= 'vote-active-up' if translation.user_vote_value(current_user) == 1 %>">
                    <svg viewBox="0 0 24 24" fill="none">
                      <path
                        d="M5 13l4 4L19 7"
                        stroke="currentColor" stroke-width="2.3"
                        stroke-linecap="round" stroke-linejoin="round"
                      />
                    </svg>
                  </div>

                  <span data-vote-target="up" class="text-xs text-slate-700">
                    <%= translation.upvotes_count %>
                  </span>
                </button>

              </div>

            </div>
          <% end %>

        </div>

      <% else %>
        <p class="mt-3 text-sm text-slate-600">No equivalent sayings found.</p>
      <% end %>
    </section>

  <% elsif @query.present? %>
    <section aria-live="polite" class="mt-8">
      <div class="rounded-2xl border border-amber-200 bg-amber-50 px-4 py-5 text-sm shadow-sm space-y-4">

        <p class="text-amber-800 break-words">
          No saying found matching “<%= @query %>”.
        </p>

        <div class="flex justify-end">
          <a
            href="<%= contribute_path(
                    source_language: @source_language.code,
                    q: @query
                  ) %>"
            class="inline-flex items-center gap-1.5 rounded-full bg-[rgb(26,115,232)] px-4 py-2
                   text-sm font-medium text-white shadow-sm hover:brightness-90 hover:shadow-md
                   focus-visible:ring-2 focus-visible:ring-slate-900/20
                   focus-visible:ring-offset-2 focus-visible:ring-offset-amber-50"
          >
            Add translation
          </a>
        </div>

      </div>
    </section>
  <% end %>
</div>
